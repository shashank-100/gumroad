#!/usr/bin/env ruby
# frozen_string_literal: true

# This script sets up Elasticsearch indices without triggering forking processes
# that cause crashes on macOS

require_relative '../config/environment'

puts "Setting up Elasticsearch indices..."

# Set the environment variable to prevent forking crashes
ENV['OBJC_DISABLE_INITIALIZE_FORK_SAFETY'] = 'YES'

# Check if Elasticsearch is running
begin
  EsClient.info
  puts "✓ Elasticsearch is running"
rescue => e
  puts "✗ Elasticsearch is not accessible: #{e.message}"
  puts "Please ensure Elasticsearch is running with: docker-compose -f docker/docker-compose-local.yml up elasticsearch"
  exit 1
end

# Create indices one by one to avoid bulk operations that might trigger forking
models = [Link, Balance, Purchase, Installment, ConfirmedFollowerEvent, ProductPageView]

models.each do |model|
  begin
    puts "Creating index for #{model.name}..."
    model.__elasticsearch__.create_index!(force: true)
    puts "✓ Created index for #{model.name}"
  rescue => e
    puts "✗ Failed to create index for #{model.name}: #{e.message}"
  end
end

puts "\nElasticsearch setup complete!"
puts "Note: You may need to manually import data if you encounter forking crashes during import."
